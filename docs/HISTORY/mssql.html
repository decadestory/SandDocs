<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HISTORY/mssql</title>
    <link rel="stylesheet" href="../../resource/theme/yuan-shan.css">
    <link rel="stylesheet" href="../../resource/css/base.css">
</head>
<body>
    <div class="markdow">
        <div class="markdow-list">
             <div class="header">
                <img class="logo" src="../../resource/image/logo.jpg"/>
                <div>JERRY♎<a href="https://github.com/decadestory" target="_blank" >GITHUB</a></div>
            </div>
            <div class="type">
                <ul>
                    <li><a href="../../docs_list/HISTORY.html">HISTORY</a></li><li><a href="../../docs_list/SandDocs.html">SandDocs</a></li><li><a href="../../docs_list/笔记本.html">笔记本</a></li>
                </ul>
            </div>
        </div>
        <div class="markdow-container">
            <h1>常用Mssql收集</h1>
<hr>
<p>1、获取表字段描述</p>
<h2></h2>
<pre style="color:#2f1e2e;background-color:#e7e9db;"><code><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span><span style="color:#815ba4">select</span> t.name, <span style="color:#815ba4">c</span>.name, ep.value  <span style="color:#815ba4">from</span> sys.tables t
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span><span style="color:#815ba4">INNER</span> <span style="color:#815ba4">JOIN</span> sys.columns <span style="color:#815ba4">c</span> <span style="color:#815ba4">ON</span> t.object_id <span style="color:#5bc4bf">=</span> <span style="color:#815ba4">c</span>.object_id
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span><span style="color:#815ba4">LEFT</span> <span style="color:#815ba4">JOIN</span> sys.extended_properties ep <span style="color:#815ba4">ON</span> ep.major_id <span style="color:#5bc4bf">=</span> <span style="color:#815ba4">c</span>.object_id <span style="color:#815ba4">AND</span> ep.minor_id <span style="color:#5bc4bf">=</span> <span style="color:#815ba4">c</span>.column_id 
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span><span><span style="color:#815ba4">WHERE</span> ep.<span style="color:#815ba4">class</span> <span style="color:#5bc4bf">=</span><span style="color:#f99b15">1</span> <span style="color:#815ba4">AND</span> t.name<span style="color:#5bc4bf">=</span><span style="color:#48b685">&#39;TABLENAME&#39;</span>
</span></span></code></pre><p>2、获取表字段信息</p>
<h2></h2>
<pre style="color:#2f1e2e;background-color:#e7e9db;"><code><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>sp_columns TABLENAME
</span></span></code></pre><p>3、添加描述</p>
<h2></h2>
<pre style="color:#2f1e2e;background-color:#e7e9db;"><code><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span><span style="color:#815ba4">EXEC</span> sp_addextendedproperty 
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span><span style="color:#48b685">&#39;MS_Description&#39;</span>,<span style="color:#48b685">&#39;description_string&#39;</span>,
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span><span style="color:#48b685">&#39;user&#39;</span>,dbo,
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span><span><span style="color:#48b685">&#39;table&#39;</span>,TABLENAME,
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span><span><span style="color:#48b685">&#39;column&#39;</span>,COLUMNNAME
</span></span></code></pre><p>4.生成实体类</p>
<h2></h2>
<pre style="color:#2f1e2e;background-color:#e7e9db;"><code><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span><span style="color:#815ba4">select</span> 
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span><span style="color:#48b685">&#39;///&lt;summary&gt;&#39;</span><span style="color:#5bc4bf">+</span>char(<span style="color:#f99b15">13</span>)<span style="color:#5bc4bf">+</span> 
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span><span style="color:#48b685">&#39;///&#39;</span><span style="color:#5bc4bf">+</span><span style="color:#815ba4">cast</span>(ep.value <span style="color:#815ba4">as</span> varchar)<span style="color:#5bc4bf">+</span>char(<span style="color:#f99b15">13</span>)<span style="color:#5bc4bf">+</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span><span style="color:#48b685">&#39;///&lt;/summary&gt;&#39;</span><span style="color:#5bc4bf">+</span>char(<span style="color:#f99b15">13</span>),
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span><span style="color:#48b685">&#39;public&#39;</span>,(
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span><span style="color:#815ba4">case</span> 
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span><span style="color:#815ba4">when</span>  ty.[name] <span style="color:#815ba4">in</span> (<span style="color:#48b685">&#39;text&#39;</span>,<span style="color:#48b685">&#39;ntext&#39;</span> ,<span style="color:#48b685">&#39;char&#39;</span>,<span style="color:#48b685">&#39;nchar&#39;</span>, <span style="color:#48b685">&#39;varchar&#39;</span>, <span style="color:#48b685">&#39;nvarchar&#39;</span>) <span style="color:#815ba4">then</span> <span style="color:#48b685">&#39;string&#39;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span><span style="color:#815ba4">when</span> ty.[name] <span style="color:#815ba4">in</span> (<span style="color:#48b685">&#39;date&#39;</span> , <span style="color:#48b685">&#39;datetime&#39;</span> , <span style="color:#48b685">&#39;datetime2&#39;</span>) <span style="color:#815ba4">then</span> <span style="color:#48b685">&#39;DateTime&#39;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span><span style="color:#815ba4">when</span> ty.[name] <span style="color:#815ba4">in</span> (<span style="color:#48b685">&#39;bit&#39;</span>) <span style="color:#815ba4">then</span> <span style="color:#48b685">&#39;bool&#39;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span><span style="color:#815ba4">when</span> ty.[name] <span style="color:#815ba4">in</span> (<span style="color:#48b685">&#39;smallint&#39;</span>) <span style="color:#815ba4">then</span> <span style="color:#48b685">&#39;short&#39;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span><span style="color:#815ba4">when</span> ty.[name] <span style="color:#815ba4">in</span> (<span style="color:#48b685">&#39;bigint&#39;</span>) <span style="color:#815ba4">then</span> <span style="color:#48b685">&#39;long&#39;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span><span style="color:#815ba4">when</span> ty.[name] <span style="color:#815ba4">in</span> (<span style="color:#48b685">&#39;real&#39;</span>) <span style="color:#815ba4">then</span> <span style="color:#48b685">&#39;float&#39;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span><span style="color:#815ba4">when</span> ty.[name] <span style="color:#815ba4">in</span> (<span style="color:#48b685">&#39;float&#39;</span>) <span style="color:#815ba4">then</span> <span style="color:#48b685">&#39;double&#39;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span><span style="color:#815ba4">when</span> ty.[name] <span style="color:#815ba4">in</span> (<span style="color:#48b685">&#39;money&#39;</span>) <span style="color:#815ba4">then</span> <span style="color:#48b685">&#39;decimal&#39;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span><span style="color:#815ba4">when</span> ty.[name] <span style="color:#815ba4">in</span> (<span style="color:#48b685">&#39;uniqueidentifier&#39;</span>) <span style="color:#815ba4">then</span> <span style="color:#48b685">&#39;Guid&#39;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span><span style="color:#815ba4">else</span> ty.[name] <span style="color:#815ba4">end</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span>) <span style="color:#815ba4">as</span> typeName,
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span><span>(<span style="color:#815ba4">case</span> <span style="color:#815ba4">c</span>.[is_nullable] <span style="color:#815ba4">when</span> <span style="color:#f99b15">1</span> <span style="color:#815ba4">then</span> 
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span><span>	<span style="color:#815ba4">case</span> <span style="color:#815ba4">when</span> ty.[name] <span style="color:#815ba4">not</span> <span style="color:#815ba4">in</span>(<span style="color:#48b685">&#39;text&#39;</span>,<span style="color:#48b685">&#39;ntext&#39;</span> ,<span style="color:#48b685">&#39;char&#39;</span>,<span style="color:#48b685">&#39;nchar&#39;</span>, <span style="color:#48b685">&#39;varchar&#39;</span>, <span style="color:#48b685">&#39;nvarchar&#39;</span>) <span style="color:#815ba4">then</span> <span style="color:#48b685">&#39;?&#39;</span> <span style="color:#815ba4">else</span> <span style="color:#48b685">&#39;&#39;</span> <span style="color:#815ba4">end</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span><span> <span style="color:#815ba4">else</span> <span style="color:#48b685">&#39;&#39;</span><span style="color:#815ba4">end</span>) <span style="color:#815ba4">as</span> isnulls
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span><span>,
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span><span><span style="color:#815ba4">c</span>.name<span style="color:#5bc4bf">+</span><span style="color:#48b685">&#39; {set;get;}&#39;</span> 
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span><span><span style="color:#815ba4">from</span> sys.tables t
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span><span><span style="color:#815ba4">INNER</span> <span style="color:#815ba4">JOIN</span> sys.columns <span style="color:#815ba4">c</span> <span style="color:#815ba4">ON</span> t.object_id <span style="color:#5bc4bf">=</span> <span style="color:#815ba4">c</span>.object_id
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span><span><span style="color:#815ba4">LEFT</span> <span style="color:#815ba4">JOIN</span> sys.extended_properties ep <span style="color:#815ba4">ON</span> ep.major_id <span style="color:#5bc4bf">=</span> <span style="color:#815ba4">c</span>.object_id <span style="color:#815ba4">AND</span> ep.minor_id <span style="color:#5bc4bf">=</span> <span style="color:#815ba4">c</span>.column_id 
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span><span><span style="color:#815ba4">left</span> <span style="color:#815ba4">JOIN</span> sys.types ty <span style="color:#815ba4">on</span> ty.[system_type_id]<span style="color:#5bc4bf">=</span><span style="color:#815ba4">c</span>.[user_type_id] <span style="color:#815ba4">and</span> ty.[name]<span style="color:#5bc4bf">!=</span><span style="color:#48b685">&#39;sysname&#39;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span><span><span style="color:#815ba4">WHERE</span> ep.<span style="color:#815ba4">class</span> <span style="color:#5bc4bf">=</span><span style="color:#f99b15">1</span> <span style="color:#815ba4">AND</span> t.name<span style="color:#5bc4bf">=</span><span style="color:#48b685">&#39;TABLENAME&#39;</span>
</span></span></code></pre><p>5.服务器获取所有数据库名</p>
<h2></h2>
<pre style="color:#2f1e2e;background-color:#e7e9db;"><code><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span><span style="color:#815ba4">SELECT</span> <span style="color:#5bc4bf">*</span> <span style="color:#815ba4">FROM</span> Master..SysDatabases <span style="color:#815ba4">ORDER</span> <span style="color:#815ba4">BY</span> Name
</span></span></code></pre><p>6.根据数据库获取所有表</p>
<h2></h2>
<pre style="color:#2f1e2e;background-color:#e7e9db;"><code><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span><span style="color:#815ba4">SELECT</span> <span style="color:#5bc4bf">*</span> <span style="color:#815ba4">FROM</span> DatabaseName..SysObjects <span style="color:#815ba4">Where</span> XType<span style="color:#5bc4bf">=</span><span style="color:#48b685">&#39;U&#39;</span> <span style="color:#815ba4">ORDER</span> <span style="color:#815ba4">BY</span> Name
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span> 
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span>XType<span style="color:#5bc4bf">=</span><span style="color:#48b685">&#39;U&#39;</span>:<span style="color:#ef6155">表示所有用户表</span>;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span><span>XType<span style="color:#5bc4bf">=</span><span style="color:#48b685">&#39;S&#39;</span>:<span style="color:#ef6155">表示所有系统表</span>;
</span></span></code></pre><p>7.根据表获取所有字段</p>
<h2></h2>
<pre style="color:#2f1e2e;background-color:#e7e9db;"><code><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span><span style="color:#815ba4">SELECT</span> <span style="color:#5bc4bf">*</span> <span style="color:#815ba4">FROM</span> SysColumns <span style="color:#815ba4">WHERE</span> id<span style="color:#5bc4bf">=</span>Object_Id(<span style="color:#48b685">&#39;TableName&#39;</span>)
</span></span></code></pre><p>8.获取所有系统类型</p>
<h2></h2>
<pre style="color:#2f1e2e;background-color:#e7e9db;"><code><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span><span style="color:#815ba4">select</span> <span style="color:#5bc4bf">*</span> <span style="color:#815ba4">from</span> sys.types
</span></span></code></pre><p>9.跨数据库查询</p>
<h2></h2>
<pre style="color:#2f1e2e;background-color:#e7e9db;"><code><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span><span style="color:#8d8687">--第一种
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span><span style="color:#8d8687"></span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span><span style="color:#8d8687">--开启
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span><span style="color:#8d8687"></span><span style="color:#815ba4">exec</span> sp_configure <span style="color:#48b685">&#39;show advanced options&#39;</span>,<span style="color:#f99b15">1</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>reconfigure
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span><span style="color:#815ba4">exec</span> sp_configure <span style="color:#48b685">&#39;Ad Hoc Distributed Queries&#39;</span>,<span style="color:#f99b15">1</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>reconfigure
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span><span style="color:#8d8687">--执行
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span><span style="color:#8d8687"></span><span style="color:#815ba4">select</span> top <span style="color:#f99b15">100</span> <span style="color:#5bc4bf">*</span> <span style="color:#815ba4">from</span> OPENDATASOURCE(<span style="color:#48b685">&#39;SQLOLEDB&#39;</span>,<span style="color:#48b685">&#39;Data Source=.;User ID=sa;Password=sa&#39;</span>).DataBaseName.dbo.TableName
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span><span style="color:#8d8687">--关闭
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span><span style="color:#8d8687"></span><span style="color:#815ba4">exec</span> sp_configure <span style="color:#48b685">&#39;Ad Hoc Distributed Queries&#39;</span>,<span style="color:#f99b15">0</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>reconfigure
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span><span style="color:#815ba4">exec</span> sp_configure <span style="color:#48b685">&#39;show advanced options&#39;</span>,<span style="color:#f99b15">0</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span>reconfigure 
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span><span style="color:#8d8687">--第二种
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span><span style="color:#8d8687"></span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span><span style="color:#8d8687">-- 创建链接服务器
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span><span><span style="color:#8d8687"></span><span style="color:#815ba4">exec</span> sp_addlinkedserver <span style="color:#48b685">&#39;svr_link&#39;</span>,<span style="color:#48b685">&#39;&#39;</span>,<span style="color:#48b685">&#39;sqloledb&#39;</span>,<span style="color:#48b685">&#39;192.168.1.1&#39;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span><span><span style="color:#8d8687">-- 创建登录信息
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span><span><span style="color:#8d8687"></span><span style="color:#815ba4">exec</span> sp_addlinkedsrvlogin <span style="color:#48b685">&#39;svr_link&#39;</span>,<span style="color:#48b685">&#39;false&#39;</span>,<span style="color:#815ba4">null</span>,<span style="color:#48b685">&#39;sa&#39;</span>,<span style="color:#48b685">&#39;sa&#39;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span><span><span style="color:#8d8687">--查询 格式为：链接服务器.数据库名.架构名.表名
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span><span><span style="color:#8d8687"></span><span style="color:#815ba4">select</span> top <span style="color:#f99b15">100</span> <span style="color:#5bc4bf">*</span> <span style="color:#815ba4">from</span> svr_link.DatabaseName.dbo.TableName
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span><span><span style="color:#8d8687">-- 删除链接服务器
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span><span><span style="color:#8d8687"></span><span style="color:#815ba4">exec</span> sp_dropserver <span style="color:#48b685">&#39;svr_link&#39;</span>,<span style="color:#48b685">&#39;droplogins&#39;</span>
</span></span></code></pre><p>10.获取数据库死锁(放在master数据库中)</p>
<h2></h2>
<pre style="color:#2f1e2e;background-color:#e7e9db;"><code><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span>USE [master]
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span><span style="color:#815ba4">GO</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span><span style="color:#8d8687">/****** Object:  StoredProcedure [dbo].[sp_who_lock]    Script Date: 2017/1/11 15:50:41 ******/</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span><span style="color:#815ba4">SET</span> ANSI_NULLS <span style="color:#815ba4">ON</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span><span style="color:#815ba4">GO</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span><span style="color:#815ba4">SET</span> QUOTED_IDENTIFIER <span style="color:#815ba4">ON</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span><span style="color:#815ba4">GO</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span><span style="color:#815ba4">CREATE</span> <span style="color:#815ba4">procedure</span> [dbo].[sp_who_lock]
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span><span style="color:#815ba4">as</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span><span style="color:#815ba4">begin</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span><span style="color:#815ba4">declare</span> <span style="color:#5bc4bf">@</span>spid int,<span style="color:#5bc4bf">@</span>bl int,
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span> <span style="color:#5bc4bf">@</span>intTransactionCountOnEntry  int,
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span>        <span style="color:#5bc4bf">@</span>intRowcount    int,
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span>        <span style="color:#5bc4bf">@</span>intCountProperties   int,
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span>        <span style="color:#5bc4bf">@</span>intCounter    int
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span> <span style="color:#815ba4">create</span> <span style="color:#815ba4">table</span> <span style="color:#5bc4bf">#</span>tmp_lock_who (
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span> id int <span style="color:#815ba4">identity</span>(<span style="color:#f99b15">1</span>,<span style="color:#f99b15">1</span>),
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span><span> spid smallint,
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span><span> bl smallint)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span><span> 
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span><span> <span style="color:#815ba4">IF</span> <span style="color:#5bc4bf">@@</span>ERROR<span style="color:#5bc4bf">&lt;&gt;</span><span style="color:#f99b15">0</span> <span style="color:#815ba4">RETURN</span> <span style="color:#5bc4bf">@@</span>ERROR
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span><span> 
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span><span> <span style="color:#815ba4">insert</span> <span style="color:#815ba4">into</span> <span style="color:#5bc4bf">#</span>tmp_lock_who(spid,bl) <span style="color:#815ba4">select</span>  <span style="color:#f99b15">0</span> ,blocked
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span><span>   <span style="color:#815ba4">from</span> (<span style="color:#815ba4">select</span> <span style="color:#5bc4bf">*</span> <span style="color:#815ba4">from</span> sysprocesses <span style="color:#815ba4">where</span>  blocked<span style="color:#5bc4bf">&gt;</span><span style="color:#f99b15">0</span> ) a 
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span><span>   <span style="color:#815ba4">where</span> <span style="color:#815ba4">not</span> <span style="color:#815ba4">exists</span>(<span style="color:#815ba4">select</span> <span style="color:#5bc4bf">*</span> <span style="color:#815ba4">from</span> (<span style="color:#815ba4">select</span> <span style="color:#5bc4bf">*</span> <span style="color:#815ba4">from</span> sysprocesses <span style="color:#815ba4">where</span>  blocked<span style="color:#5bc4bf">&gt;</span><span style="color:#f99b15">0</span> ) b 
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span><span>   <span style="color:#815ba4">where</span> a.blocked<span style="color:#5bc4bf">=</span>spid)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span><span>   <span style="color:#815ba4">union</span> <span style="color:#815ba4">select</span> spid,blocked <span style="color:#815ba4">from</span> sysprocesses <span style="color:#815ba4">where</span>  blocked<span style="color:#5bc4bf">&gt;</span><span style="color:#f99b15">0</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span><span> <span style="color:#815ba4">IF</span> <span style="color:#5bc4bf">@@</span>ERROR<span style="color:#5bc4bf">&lt;&gt;</span><span style="color:#f99b15">0</span> <span style="color:#815ba4">RETURN</span> <span style="color:#5bc4bf">@@</span>ERROR 
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span><span>  
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span><span><span style="color:#8d8687">-- 找到临时表的记录数
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33</span><span><span style="color:#8d8687"></span> <span style="color:#815ba4">select</span>  <span style="color:#5bc4bf">@</span>intCountProperties <span style="color:#5bc4bf">=</span> <span style="color:#815ba4">Count</span>(<span style="color:#5bc4bf">*</span>),<span style="color:#5bc4bf">@</span>intCounter <span style="color:#5bc4bf">=</span> <span style="color:#f99b15">1</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34</span><span> <span style="color:#815ba4">from</span> <span style="color:#5bc4bf">#</span>tmp_lock_who
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35</span><span> 
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36</span><span> <span style="color:#815ba4">IF</span> <span style="color:#5bc4bf">@@</span>ERROR<span style="color:#5bc4bf">&lt;&gt;</span><span style="color:#f99b15">0</span> <span style="color:#815ba4">RETURN</span> <span style="color:#5bc4bf">@@</span>ERROR 
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37</span><span> 
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38</span><span> <span style="color:#815ba4">if</span> <span style="color:#5bc4bf">@</span>intCountProperties<span style="color:#5bc4bf">=</span><span style="color:#f99b15">0</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39</span><span>  <span style="color:#815ba4">select</span> <span style="color:#48b685">&#39;现在没有阻塞和死锁信息&#39;</span> <span style="color:#815ba4">as</span> message
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41</span><span><span style="color:#8d8687">-- 循环开始
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42</span><span><span style="color:#8d8687"></span>while <span style="color:#5bc4bf">@</span>intCounter <span style="color:#5bc4bf">&lt;=</span> <span style="color:#5bc4bf">@</span>intCountProperties
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43</span><span><span style="color:#815ba4">begin</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44</span><span><span style="color:#8d8687">-- 取第一条记录
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45</span><span><span style="color:#8d8687"></span>  <span style="color:#815ba4">select</span>  <span style="color:#5bc4bf">@</span>spid <span style="color:#5bc4bf">=</span> spid,<span style="color:#5bc4bf">@</span>bl <span style="color:#5bc4bf">=</span> bl
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46</span><span>  <span style="color:#815ba4">from</span> <span style="color:#5bc4bf">#</span>tmp_lock_who <span style="color:#815ba4">where</span> Id <span style="color:#5bc4bf">=</span> <span style="color:#5bc4bf">@</span>intCounter 
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47</span><span> <span style="color:#815ba4">begin</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48</span><span>  <span style="color:#815ba4">if</span> <span style="color:#5bc4bf">@</span>spid <span style="color:#5bc4bf">=</span><span style="color:#f99b15">0</span> 
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49</span><span>            <span style="color:#815ba4">select</span> <span style="color:#48b685">&#39;引起数据库死锁的是: &#39;</span><span style="color:#5bc4bf">+</span> <span style="color:#815ba4">CAST</span>(<span style="color:#5bc4bf">@</span>bl <span style="color:#815ba4">AS</span> VARCHAR(<span style="color:#f99b15">10</span>)) <span style="color:#5bc4bf">+</span> <span style="color:#48b685">&#39;进程号,其执行的SQL语法如下&#39;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50</span><span> <span style="color:#815ba4">else</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51</span><span>            <span style="color:#815ba4">select</span> <span style="color:#48b685">&#39;进程号SPID：&#39;</span><span style="color:#5bc4bf">+</span> <span style="color:#815ba4">CAST</span>(<span style="color:#5bc4bf">@</span>spid <span style="color:#815ba4">AS</span> VARCHAR(<span style="color:#f99b15">10</span>))<span style="color:#5bc4bf">+</span> <span style="color:#48b685">&#39;被&#39;</span> <span style="color:#5bc4bf">+</span> <span style="color:#48b685">&#39;进程号SPID：&#39;</span><span style="color:#5bc4bf">+</span> <span style="color:#815ba4">CAST</span>(<span style="color:#5bc4bf">@</span>bl <span style="color:#815ba4">AS</span> VARCHAR(<span style="color:#f99b15">10</span>)) <span style="color:#5bc4bf">+</span><span style="color:#48b685">&#39;阻塞,其当前进程执行的SQL语法如下&#39;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52</span><span> DBCC INPUTBUFFER (<span style="color:#5bc4bf">@</span>bl )
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53</span><span> <span style="color:#815ba4">end</span> 
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55</span><span><span style="color:#8d8687">-- 循环指针下移
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56</span><span><span style="color:#8d8687"></span> <span style="color:#815ba4">set</span> <span style="color:#5bc4bf">@</span>intCounter <span style="color:#5bc4bf">=</span> <span style="color:#5bc4bf">@</span>intCounter <span style="color:#5bc4bf">+</span> <span style="color:#f99b15">1</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57</span><span><span style="color:#815ba4">end</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59</span><span><span style="color:#815ba4">drop</span> <span style="color:#815ba4">table</span> <span style="color:#5bc4bf">#</span>tmp_lock_who
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61</span><span><span style="color:#815ba4">return</span> <span style="color:#f99b15">0</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">62</span><span><span style="color:#815ba4">end</span>
</span></span></code></pre><pre><code>用法：exec sp_who_lock
</code></pre>
<p>11.杀掉死锁进程（放在master数据库中）</p>
<h2></h2>
<pre style="color:#2f1e2e;background-color:#e7e9db;"><code><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span>USE [master]
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span><span style="color:#815ba4">GO</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span><span style="color:#8d8687">/****** Object:  StoredProcedure [dbo].[p_killspid]    Script Date: 2017/1/11 15:59:36 ******/</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span><span style="color:#815ba4">SET</span> ANSI_NULLS <span style="color:#815ba4">ON</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span><span style="color:#815ba4">GO</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span><span style="color:#815ba4">SET</span> QUOTED_IDENTIFIER <span style="color:#815ba4">ON</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span><span style="color:#815ba4">GO</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span><span style="color:#815ba4">ALTER</span> proc [dbo].[p_killspid]
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span><span style="color:#5bc4bf">@</span>dbname varchar(<span style="color:#f99b15">200</span>)    <span style="color:#8d8687">--要关闭进程的数据库名
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span><span style="color:#8d8687"></span><span style="color:#815ba4">as</span>  
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>	<span style="color:#815ba4">begin</span> 
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span>    <span style="color:#815ba4">declare</span> <span style="color:#5bc4bf">@</span><span style="color:#815ba4">sql</span>  nvarchar(<span style="color:#f99b15">500</span>)  
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span>    <span style="color:#815ba4">declare</span> <span style="color:#5bc4bf">@</span>spid nvarchar(<span style="color:#f99b15">20</span>)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span>    <span style="color:#815ba4">declare</span> <span style="color:#5bc4bf">#</span>tb <span style="color:#815ba4">cursor</span> <span style="color:#815ba4">for</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span>        <span style="color:#815ba4">select</span> spid<span style="color:#5bc4bf">=</span><span style="color:#815ba4">cast</span>(spid <span style="color:#815ba4">as</span> varchar(<span style="color:#f99b15">20</span>)) <span style="color:#815ba4">from</span> master..sysprocesses <span style="color:#815ba4">where</span> dbid<span style="color:#5bc4bf">=</span>db_id(<span style="color:#5bc4bf">@</span>dbname)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span><span>    <span style="color:#815ba4">open</span> <span style="color:#5bc4bf">#</span>tb
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span><span>    <span style="color:#815ba4">fetch</span> <span style="color:#815ba4">next</span> <span style="color:#815ba4">from</span> <span style="color:#5bc4bf">#</span>tb <span style="color:#815ba4">into</span> <span style="color:#5bc4bf">@</span>spid
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span><span>    while <span style="color:#5bc4bf">@@</span>fetch_status<span style="color:#5bc4bf">=</span><span style="color:#f99b15">0</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span><span>    <span style="color:#815ba4">begin</span>  
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span><span>        <span style="color:#815ba4">exec</span>(<span style="color:#48b685">&#39;kill &#39;</span><span style="color:#5bc4bf">+@</span>spid)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span><span>        <span style="color:#815ba4">fetch</span> <span style="color:#815ba4">next</span> <span style="color:#815ba4">from</span> <span style="color:#5bc4bf">#</span>tb <span style="color:#815ba4">into</span> <span style="color:#5bc4bf">@</span>spid
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span><span>    <span style="color:#815ba4">end</span>  
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span><span>    <span style="color:#815ba4">close</span> <span style="color:#5bc4bf">#</span>tb
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span><span>    <span style="color:#815ba4">deallocate</span> <span style="color:#5bc4bf">#</span>tb
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span><span>	<span style="color:#815ba4">end</span>
</span></span></code></pre><pre><code>用法：exec p_killspid  '数据库名'
</code></pre>
<p>12.查询死锁表信息（放在master数据库中）</p>
<h2></h2>
<pre style="color:#2f1e2e;background-color:#e7e9db;"><code><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span>USE [master]
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span><span style="color:#815ba4">GO</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span><span style="color:#8d8687">/****** Object:  StoredProcedure [dbo].[sp_lock_table]    Script Date: 2017/1/11 16:02:01 ******/</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span><span style="color:#815ba4">SET</span> ANSI_NULLS <span style="color:#815ba4">ON</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span><span style="color:#815ba4">GO</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span><span style="color:#815ba4">SET</span> QUOTED_IDENTIFIER <span style="color:#815ba4">ON</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span><span style="color:#815ba4">GO</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span><span style="color:#815ba4">ALTER</span> <span style="color:#815ba4">PROCEDURE</span> [dbo].[sp_lock_table]
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span><span style="color:#815ba4">AS</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span><span style="color:#815ba4">BEGIN</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>	
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span><span style="color:#8d8687">--查看锁信息
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span><span style="color:#8d8687"></span><span style="color:#815ba4">create</span> <span style="color:#815ba4">table</span> <span style="color:#5bc4bf">#</span>t(req_spid int,obj_name sysname)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span><span style="color:#815ba4">declare</span> <span style="color:#5bc4bf">@</span>s nvarchar(<span style="color:#f99b15">4000</span>)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span>    ,<span style="color:#5bc4bf">@</span>rid int,<span style="color:#5bc4bf">@</span>dbname sysname,<span style="color:#5bc4bf">@</span>id int,<span style="color:#5bc4bf">@</span>objname sysname
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span><span><span style="color:#815ba4">declare</span> tb <span style="color:#815ba4">cursor</span> <span style="color:#815ba4">for</span> 
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span><span>    <span style="color:#815ba4">select</span> <span style="color:#815ba4">distinct</span> req_spid,dbname<span style="color:#5bc4bf">=</span>db_name(rsc_dbid),rsc_objid
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span><span>    <span style="color:#815ba4">from</span> master..syslockinfo <span style="color:#815ba4">where</span> rsc_type <span style="color:#815ba4">in</span>(<span style="color:#f99b15">4</span>,<span style="color:#f99b15">5</span>)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span><span><span style="color:#815ba4">open</span> tb
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span><span><span style="color:#815ba4">fetch</span> <span style="color:#815ba4">next</span> <span style="color:#815ba4">from</span> tb <span style="color:#815ba4">into</span> <span style="color:#5bc4bf">@</span>rid,<span style="color:#5bc4bf">@</span>dbname,<span style="color:#5bc4bf">@</span>id
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span><span>while <span style="color:#5bc4bf">@@</span>fetch_status<span style="color:#5bc4bf">=</span><span style="color:#f99b15">0</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span><span><span style="color:#815ba4">begin</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span><span>    <span style="color:#815ba4">set</span> <span style="color:#5bc4bf">@</span>s<span style="color:#5bc4bf">=</span><span style="color:#48b685">&#39;select @objname=name from [&#39;</span><span style="color:#5bc4bf">+@</span>dbname<span style="color:#5bc4bf">+</span><span style="color:#48b685">&#39;]..sysobjects where id=@id&#39;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span><span>    <span style="color:#815ba4">exec</span> sp_executesql <span style="color:#5bc4bf">@</span>s,N<span style="color:#48b685">&#39;@objname sysname out,@id int&#39;</span>,<span style="color:#5bc4bf">@</span>objname <span style="color:#815ba4">out</span>,<span style="color:#5bc4bf">@</span>id
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span><span>    <span style="color:#815ba4">insert</span> <span style="color:#815ba4">into</span> <span style="color:#5bc4bf">#</span>t <span style="color:#815ba4">values</span>(<span style="color:#5bc4bf">@</span>rid,<span style="color:#5bc4bf">@</span>objname)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span><span>    <span style="color:#815ba4">fetch</span> <span style="color:#815ba4">next</span> <span style="color:#815ba4">from</span> tb <span style="color:#815ba4">into</span> <span style="color:#5bc4bf">@</span>rid,<span style="color:#5bc4bf">@</span>dbname,<span style="color:#5bc4bf">@</span>id
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span><span><span style="color:#815ba4">end</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span><span><span style="color:#815ba4">close</span> tb
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span><span><span style="color:#815ba4">deallocate</span> tb
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34</span><span><span style="color:#815ba4">select</span> <span style="color:#ef6155">进程</span>id<span style="color:#5bc4bf">=</span>a.req_spid
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35</span><span>    ,<span style="color:#ef6155">数据库</span><span style="color:#5bc4bf">=</span>db_name(rsc_dbid)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36</span><span>    ,<span style="color:#ef6155">类型</span><span style="color:#5bc4bf">=</span><span style="color:#815ba4">case</span> rsc_type <span style="color:#815ba4">when</span> <span style="color:#f99b15">1</span> <span style="color:#815ba4">then</span> <span style="color:#48b685">&#39;NULL 资源（未使用）&#39;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37</span><span>        <span style="color:#815ba4">when</span> <span style="color:#f99b15">2</span> <span style="color:#815ba4">then</span> <span style="color:#48b685">&#39;数据库&#39;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38</span><span>        <span style="color:#815ba4">when</span> <span style="color:#f99b15">3</span> <span style="color:#815ba4">then</span> <span style="color:#48b685">&#39;文件&#39;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39</span><span>        <span style="color:#815ba4">when</span> <span style="color:#f99b15">4</span> <span style="color:#815ba4">then</span> <span style="color:#48b685">&#39;索引&#39;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40</span><span>        <span style="color:#815ba4">when</span> <span style="color:#f99b15">5</span> <span style="color:#815ba4">then</span> <span style="color:#48b685">&#39;表&#39;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41</span><span>        <span style="color:#815ba4">when</span> <span style="color:#f99b15">6</span> <span style="color:#815ba4">then</span> <span style="color:#48b685">&#39;页&#39;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42</span><span>        <span style="color:#815ba4">when</span> <span style="color:#f99b15">7</span> <span style="color:#815ba4">then</span> <span style="color:#48b685">&#39;键&#39;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43</span><span>        <span style="color:#815ba4">when</span> <span style="color:#f99b15">8</span> <span style="color:#815ba4">then</span> <span style="color:#48b685">&#39;扩展盘区&#39;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44</span><span>        <span style="color:#815ba4">when</span> <span style="color:#f99b15">9</span> <span style="color:#815ba4">then</span> <span style="color:#48b685">&#39;RID（行 ID)&#39;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45</span><span>        <span style="color:#815ba4">when</span> <span style="color:#f99b15">10</span> <span style="color:#815ba4">then</span> <span style="color:#48b685">&#39;应用程序&#39;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46</span><span>    <span style="color:#815ba4">end</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47</span><span>    ,<span style="color:#ef6155">对象</span>id<span style="color:#5bc4bf">=</span>rsc_objid
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48</span><span>    ,<span style="color:#ef6155">对象名</span><span style="color:#5bc4bf">=</span>b.obj_name
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49</span><span>    ,rsc_indid
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50</span><span> <span style="color:#815ba4">from</span> master..syslockinfo a <span style="color:#815ba4">left</span> <span style="color:#815ba4">join</span> <span style="color:#5bc4bf">#</span>t b <span style="color:#815ba4">on</span> a.req_spid<span style="color:#5bc4bf">=</span>b.req_spid
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52</span><span><span style="color:#815ba4">drop</span> <span style="color:#815ba4">table</span> <span style="color:#5bc4bf">#</span>t
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54</span><span><span style="color:#815ba4">END</span>
</span></span></code></pre><pre><code>用法：exec sp_lock_table
</code></pre>
<p>13.查询执行慢的SQL</p>
<h2></h2>
<pre style="color:#2f1e2e;background-color:#e7e9db;"><code><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span><span style="color:#815ba4">SELECT</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>(total_elapsed_time <span style="color:#5bc4bf">/</span> execution_count)<span style="color:#5bc4bf">/</span><span style="color:#f99b15">1000</span> N<span style="color:#48b685">&#39;平均时间ms&#39;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>,total_elapsed_time<span style="color:#5bc4bf">/</span><span style="color:#f99b15">1000</span> N<span style="color:#48b685">&#39;总花费时间ms&#39;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>,total_worker_time<span style="color:#5bc4bf">/</span><span style="color:#f99b15">1000</span> N<span style="color:#48b685">&#39;所用的CPU总时间ms&#39;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>,total_physical_reads N<span style="color:#48b685">&#39;物理读取总次数&#39;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>,total_logical_reads<span style="color:#5bc4bf">/</span>execution_count N<span style="color:#48b685">&#39;每次逻辑读次数&#39;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>,total_logical_reads N<span style="color:#48b685">&#39;逻辑读取总次数&#39;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>,total_logical_writes N<span style="color:#48b685">&#39;逻辑写入总次数&#39;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>,execution_count N<span style="color:#48b685">&#39;执行次数&#39;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>,<span style="color:#815ba4">SUBSTRING</span>(st.text, (qs.statement_start_offset<span style="color:#5bc4bf">/</span><span style="color:#f99b15">2</span>) <span style="color:#5bc4bf">+</span> <span style="color:#f99b15">1</span>,
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>((<span style="color:#815ba4">CASE</span> statement_end_offset
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span><span style="color:#815ba4">WHEN</span> <span style="color:#5bc4bf">-</span><span style="color:#f99b15">1</span> <span style="color:#815ba4">THEN</span> DATALENGTH(st.text)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span><span style="color:#815ba4">ELSE</span> qs.statement_end_offset <span style="color:#815ba4">END</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span><span style="color:#5bc4bf">-</span> qs.statement_start_offset)<span style="color:#5bc4bf">/</span><span style="color:#f99b15">2</span>) <span style="color:#5bc4bf">+</span> <span style="color:#f99b15">1</span>) N<span style="color:#48b685">&#39;执行语句&#39;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span>,creation_time N<span style="color:#48b685">&#39;语句编译时间&#39;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span>,last_execution_time N<span style="color:#48b685">&#39;上次执行时间&#39;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span><span style="color:#815ba4">FROM</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span>sys.dm_exec_query_stats <span style="color:#815ba4">AS</span> qs <span style="color:#815ba4">CROSS</span> APPLY sys.dm_exec_sql_text(qs.sql_handle) st
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span><span><span style="color:#815ba4">WHERE</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span><span><span style="color:#815ba4">SUBSTRING</span>(st.text, (qs.statement_start_offset<span style="color:#5bc4bf">/</span><span style="color:#f99b15">2</span>) <span style="color:#5bc4bf">+</span> <span style="color:#f99b15">1</span>,
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span><span>((<span style="color:#815ba4">CASE</span> statement_end_offset
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span><span><span style="color:#815ba4">WHEN</span> <span style="color:#5bc4bf">-</span><span style="color:#f99b15">1</span> <span style="color:#815ba4">THEN</span> DATALENGTH(st.text)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span><span><span style="color:#815ba4">ELSE</span> qs.statement_end_offset <span style="color:#815ba4">END</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span><span><span style="color:#5bc4bf">-</span> qs.statement_start_offset)<span style="color:#5bc4bf">/</span><span style="color:#f99b15">2</span>) <span style="color:#5bc4bf">+</span> <span style="color:#f99b15">1</span>) <span style="color:#815ba4">not</span> <span style="color:#815ba4">like</span> <span style="color:#48b685">&#39;%fetch%&#39;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span><span><span style="color:#815ba4">ORDER</span> <span style="color:#815ba4">BY</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span><span>total_elapsed_time <span style="color:#5bc4bf">/</span> execution_count <span style="color:#815ba4">DESC</span>;
</span></span></code></pre><p>14.查询执行过的SQL计划</p>
<h2></h2>
<pre style="color:#2f1e2e;background-color:#e7e9db;"><code><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span><span style="color:#815ba4">SELECT</span> TOP <span style="color:#f99b15">1000</span> 
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>    QS.creation_time,
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>    <span style="color:#815ba4">SUBSTRING</span>(ST.text,(QS.statement_start_offset<span style="color:#5bc4bf">/</span><span style="color:#f99b15">2</span>)<span style="color:#5bc4bf">+</span><span style="color:#f99b15">1</span>,
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>    ((<span style="color:#815ba4">CASE</span> QS.statement_end_offset <span style="color:#815ba4">WHEN</span> <span style="color:#5bc4bf">-</span><span style="color:#f99b15">1</span> <span style="color:#815ba4">THEN</span> DATALENGTH(st.text) 
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>        <span style="color:#815ba4">ELSE</span> QS.statement_end_offset <span style="color:#815ba4">END</span> <span style="color:#5bc4bf">-</span> QS.statement_start_offset)<span style="color:#5bc4bf">/</span><span style="color:#f99b15">2</span>) <span style="color:#5bc4bf">+</span> <span style="color:#f99b15">1</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>    ) <span style="color:#815ba4">AS</span> statement_text,
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>    ST.text,
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>    QS.total_worker_time,
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>    QS.last_worker_time,
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>    QS.max_worker_time,
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>    QS.min_worker_time
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span><span style="color:#815ba4">FROM</span> 
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span>    sys.dm_exec_query_stats QS
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span><span style="color:#815ba4">CROSS</span> APPLY 
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span>    sys.dm_exec_sql_text(QS.sql_handle) ST
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span><span style="color:#815ba4">WHERE</span> QS.creation_time <span style="color:#815ba4">BETWEEN</span> <span style="color:#48b685">&#39;2018-05-22 15:00:00&#39;</span> <span style="color:#815ba4">AND</span> <span style="color:#48b685">&#39;2018-05-22 15:10:00&#39;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span><span style="color:#815ba4">ORDER</span> <span style="color:#815ba4">BY</span> QS.creation_time <span style="color:#815ba4">DESC</span>
</span></span></code></pre>
        </div>   
    </div>
</body>
</html>