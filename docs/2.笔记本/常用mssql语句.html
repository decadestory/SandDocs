<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2.笔记本/常用mssql语句</title>
    <link rel="stylesheet" href="../../resource/theme/yuan-shan.css">
    <link rel="stylesheet" href="../../resource/css/base.css">
</head>
<body>
    <div class="markdow">
        <div class="markdow-list">
             <div class="header">
                <img class="logo" src="../../resource/image/logo.jpg"/>
                <div>JERRY♎<a href="https://github.com/decadestory" target="_blank" >GITHUB</a></div>
            </div>
            <div class="type">
                <ul>
                    <li><a href="../../docs_list/1.SandDocs.html">SandDocs</a></li><li><a href="../../docs_list/2.笔记本.html">笔记本</a></li><li><a href="../../docs_list/4.HISTORY.html">HISTORY</a></li><li><a href="../../docs_list/5.平衡.html">平衡</a></li><li><a href="../../docs_list/6.一些小诗.html">一些小诗</a></li><li><a href="../../docs_list/7.关于JERRY.html">关于JERRY</a></li>
                </ul>
            </div>
        </div>
        <div class="markdow-container">
            <div class="markdow-content">
                <h1>常用Mssql收集</h1>
<hr>
<p>1、获取表字段描述</p>
<h2></h2>
<pre style="color:#f8f8f2;background-color:#282a36;"><code><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#ff79c6;font-style:normal;">select</span> t.name, <span style="color:#ff79c6;font-style:normal;">c</span>.name, ep.value  <span style="color:#ff79c6;font-style:normal;">from</span> sys.tables t
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#ff79c6;font-style:normal;">INNER</span> <span style="color:#ff79c6;font-style:normal;">JOIN</span> sys.columns <span style="color:#ff79c6;font-style:normal;">c</span> <span style="color:#ff79c6;font-style:normal;">ON</span> t.object_id <span style="color:#ff79c6">=</span> <span style="color:#ff79c6;font-style:normal;">c</span>.object_id
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#ff79c6;font-style:normal;">LEFT</span> <span style="color:#ff79c6;font-style:normal;">JOIN</span> sys.extended_properties ep <span style="color:#ff79c6;font-style:normal;">ON</span> ep.major_id <span style="color:#ff79c6">=</span> <span style="color:#ff79c6;font-style:normal;">c</span>.object_id <span style="color:#ff79c6;font-style:normal;">AND</span> ep.minor_id <span style="color:#ff79c6">=</span> <span style="color:#ff79c6;font-style:normal;">c</span>.column_id 
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#ff79c6;font-style:normal;">WHERE</span> ep.<span style="color:#ff79c6;font-style:normal;">class</span> <span style="color:#ff79c6">=</span><span style="color:#bd93f9">1</span> <span style="color:#ff79c6;font-style:normal;">AND</span> t.name<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;TABLENAME&#39;</span>
</span></span></code></pre><p>2、获取表字段信息</p>
<h2></h2>
<pre style="color:#f8f8f2;background-color:#282a36;"><code><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>sp_columns TABLENAME
</span></span></code></pre><p>3、添加描述</p>
<h2></h2>
<pre style="color:#f8f8f2;background-color:#282a36;"><code><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#ff79c6;font-style:normal;">EXEC</span> sp_addextendedproperty 
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#f1fa8c">&#39;MS_Description&#39;</span>,<span style="color:#f1fa8c">&#39;description_string&#39;</span>,
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#f1fa8c">&#39;user&#39;</span>,dbo,
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#f1fa8c">&#39;table&#39;</span>,TABLENAME,
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#f1fa8c">&#39;column&#39;</span>,COLUMNNAME
</span></span></code></pre><p>4.生成实体类</p>
<h2></h2>
<pre style="color:#f8f8f2;background-color:#282a36;"><code><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#ff79c6;font-style:normal;">select</span> 
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#f1fa8c">&#39;///&lt;summary&gt;&#39;</span><span style="color:#ff79c6">+</span><span style="color:#8be9fd;font-style:italic">char</span>(<span style="color:#bd93f9">13</span>)<span style="color:#ff79c6">+</span> 
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#f1fa8c">&#39;///&#39;</span><span style="color:#ff79c6">+</span><span style="color:#ff79c6;font-style:normal;">cast</span>(ep.value <span style="color:#ff79c6;font-style:normal;">as</span> <span style="color:#8be9fd;font-style:italic">varchar</span>)<span style="color:#ff79c6">+</span><span style="color:#8be9fd;font-style:italic">char</span>(<span style="color:#bd93f9">13</span>)<span style="color:#ff79c6">+</span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#f1fa8c">&#39;///&lt;/summary&gt;&#39;</span><span style="color:#ff79c6">+</span><span style="color:#8be9fd;font-style:italic">char</span>(<span style="color:#bd93f9">13</span>),
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#f1fa8c">&#39;public&#39;</span>,(
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#ff79c6;font-style:normal;">case</span> 
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#ff79c6;font-style:normal;">when</span>  ty.[name] <span style="color:#ff79c6;font-style:normal;">in</span> (<span style="color:#f1fa8c">&#39;text&#39;</span>,<span style="color:#f1fa8c">&#39;ntext&#39;</span> ,<span style="color:#f1fa8c">&#39;char&#39;</span>,<span style="color:#f1fa8c">&#39;nchar&#39;</span>, <span style="color:#f1fa8c">&#39;varchar&#39;</span>, <span style="color:#f1fa8c">&#39;nvarchar&#39;</span>) <span style="color:#ff79c6;font-style:normal;">then</span> <span style="color:#f1fa8c">&#39;string&#39;</span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#ff79c6;font-style:normal;">when</span> ty.[name] <span style="color:#ff79c6;font-style:normal;">in</span> (<span style="color:#f1fa8c">&#39;date&#39;</span> , <span style="color:#f1fa8c">&#39;datetime&#39;</span> , <span style="color:#f1fa8c">&#39;datetime2&#39;</span>) <span style="color:#ff79c6;font-style:normal;">then</span> <span style="color:#f1fa8c">&#39;DateTime&#39;</span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#ff79c6;font-style:normal;">when</span> ty.[name] <span style="color:#ff79c6;font-style:normal;">in</span> (<span style="color:#f1fa8c">&#39;bit&#39;</span>) <span style="color:#ff79c6;font-style:normal;">then</span> <span style="color:#f1fa8c">&#39;bool&#39;</span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#ff79c6;font-style:normal;">when</span> ty.[name] <span style="color:#ff79c6;font-style:normal;">in</span> (<span style="color:#f1fa8c">&#39;smallint&#39;</span>) <span style="color:#ff79c6;font-style:normal;">then</span> <span style="color:#f1fa8c">&#39;short&#39;</span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#ff79c6;font-style:normal;">when</span> ty.[name] <span style="color:#ff79c6;font-style:normal;">in</span> (<span style="color:#f1fa8c">&#39;bigint&#39;</span>) <span style="color:#ff79c6;font-style:normal;">then</span> <span style="color:#f1fa8c">&#39;long&#39;</span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#ff79c6;font-style:normal;">when</span> ty.[name] <span style="color:#ff79c6;font-style:normal;">in</span> (<span style="color:#f1fa8c">&#39;real&#39;</span>) <span style="color:#ff79c6;font-style:normal;">then</span> <span style="color:#f1fa8c">&#39;float&#39;</span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#ff79c6;font-style:normal;">when</span> ty.[name] <span style="color:#ff79c6;font-style:normal;">in</span> (<span style="color:#f1fa8c">&#39;float&#39;</span>) <span style="color:#ff79c6;font-style:normal;">then</span> <span style="color:#f1fa8c">&#39;double&#39;</span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#ff79c6;font-style:normal;">when</span> ty.[name] <span style="color:#ff79c6;font-style:normal;">in</span> (<span style="color:#f1fa8c">&#39;money&#39;</span>) <span style="color:#ff79c6;font-style:normal;">then</span> <span style="color:#f1fa8c">&#39;decimal&#39;</span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#ff79c6;font-style:normal;">when</span> ty.[name] <span style="color:#ff79c6;font-style:normal;">in</span> (<span style="color:#f1fa8c">&#39;uniqueidentifier&#39;</span>) <span style="color:#ff79c6;font-style:normal;">then</span> <span style="color:#f1fa8c">&#39;Guid&#39;</span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#ff79c6;font-style:normal;">else</span> ty.[name] <span style="color:#ff79c6;font-style:normal;">end</span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>) <span style="color:#ff79c6;font-style:normal;">as</span> typeName,
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>(<span style="color:#ff79c6;font-style:normal;">case</span> <span style="color:#ff79c6;font-style:normal;">c</span>.[is_nullable] <span style="color:#ff79c6;font-style:normal;">when</span> <span style="color:#bd93f9">1</span> <span style="color:#ff79c6;font-style:normal;">then</span> 
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>	<span style="color:#ff79c6;font-style:normal;">case</span> <span style="color:#ff79c6;font-style:normal;">when</span> ty.[name] <span style="color:#ff79c6;font-style:normal;">not</span> <span style="color:#ff79c6;font-style:normal;">in</span>(<span style="color:#f1fa8c">&#39;text&#39;</span>,<span style="color:#f1fa8c">&#39;ntext&#39;</span> ,<span style="color:#f1fa8c">&#39;char&#39;</span>,<span style="color:#f1fa8c">&#39;nchar&#39;</span>, <span style="color:#f1fa8c">&#39;varchar&#39;</span>, <span style="color:#f1fa8c">&#39;nvarchar&#39;</span>) <span style="color:#ff79c6;font-style:normal;">then</span> <span style="color:#f1fa8c">&#39;?&#39;</span> <span style="color:#ff79c6;font-style:normal;">else</span> <span style="color:#f1fa8c">&#39;&#39;</span> <span style="color:#ff79c6;font-style:normal;">end</span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span> <span style="color:#ff79c6;font-style:normal;">else</span> <span style="color:#f1fa8c">&#39;&#39;</span><span style="color:#ff79c6;font-style:normal;">end</span>) <span style="color:#ff79c6;font-style:normal;">as</span> isnulls
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>,
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#ff79c6;font-style:normal;">c</span>.name<span style="color:#ff79c6">+</span><span style="color:#f1fa8c">&#39; {set;get;}&#39;</span> 
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#ff79c6;font-style:normal;">from</span> sys.tables t
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#ff79c6;font-style:normal;">INNER</span> <span style="color:#ff79c6;font-style:normal;">JOIN</span> sys.columns <span style="color:#ff79c6;font-style:normal;">c</span> <span style="color:#ff79c6;font-style:normal;">ON</span> t.object_id <span style="color:#ff79c6">=</span> <span style="color:#ff79c6;font-style:normal;">c</span>.object_id
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#ff79c6;font-style:normal;">LEFT</span> <span style="color:#ff79c6;font-style:normal;">JOIN</span> sys.extended_properties ep <span style="color:#ff79c6;font-style:normal;">ON</span> ep.major_id <span style="color:#ff79c6">=</span> <span style="color:#ff79c6;font-style:normal;">c</span>.object_id <span style="color:#ff79c6;font-style:normal;">AND</span> ep.minor_id <span style="color:#ff79c6">=</span> <span style="color:#ff79c6;font-style:normal;">c</span>.column_id 
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#ff79c6;font-style:normal;">left</span> <span style="color:#ff79c6;font-style:normal;">JOIN</span> sys.types ty <span style="color:#ff79c6;font-style:normal;">on</span> ty.[system_type_id]<span style="color:#ff79c6">=</span><span style="color:#ff79c6;font-style:normal;">c</span>.[user_type_id] <span style="color:#ff79c6;font-style:normal;">and</span> ty.[name]<span style="color:#ff79c6">!=</span><span style="color:#f1fa8c">&#39;sysname&#39;</span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#ff79c6;font-style:normal;">WHERE</span> ep.<span style="color:#ff79c6;font-style:normal;">class</span> <span style="color:#ff79c6">=</span><span style="color:#bd93f9">1</span> <span style="color:#ff79c6;font-style:normal;">AND</span> t.name<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;TABLENAME&#39;</span>
</span></span></code></pre><p>5.服务器获取所有数据库名</p>
<h2></h2>
<pre style="color:#f8f8f2;background-color:#282a36;"><code><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#ff79c6;font-style:normal;">SELECT</span> <span style="color:#ff79c6">*</span> <span style="color:#ff79c6;font-style:normal;">FROM</span> Master..SysDatabases <span style="color:#ff79c6;font-style:normal;">ORDER</span> <span style="color:#ff79c6;font-style:normal;">BY</span> Name
</span></span></code></pre><p>6.根据数据库获取所有表</p>
<h2></h2>
<pre style="color:#f8f8f2;background-color:#282a36;"><code><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#ff79c6;font-style:normal;">SELECT</span> <span style="color:#ff79c6">*</span> <span style="color:#ff79c6;font-style:normal;">FROM</span> DatabaseName..SysObjects <span style="color:#ff79c6;font-style:normal;">Where</span> XType<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;U&#39;</span> <span style="color:#ff79c6;font-style:normal;">ORDER</span> <span style="color:#ff79c6;font-style:normal;">BY</span> Name
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span> 
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>XType<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;U&#39;</span>:表示所有用户表;
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>XType<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;S&#39;</span>:表示所有系统表;
</span></span></code></pre><p>7.根据表获取所有字段</p>
<h2></h2>
<pre style="color:#f8f8f2;background-color:#282a36;"><code><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#ff79c6;font-style:normal;">SELECT</span> <span style="color:#ff79c6">*</span> <span style="color:#ff79c6;font-style:normal;">FROM</span> SysColumns <span style="color:#ff79c6;font-style:normal;">WHERE</span> id<span style="color:#ff79c6">=</span>Object_Id(<span style="color:#f1fa8c">&#39;TableName&#39;</span>)
</span></span></code></pre><p>8.获取所有系统类型</p>
<h2></h2>
<pre style="color:#f8f8f2;background-color:#282a36;"><code><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#ff79c6;font-style:normal;">select</span> <span style="color:#ff79c6">*</span> <span style="color:#ff79c6;font-style:normal;">from</span> sys.types
</span></span></code></pre><p>9.跨数据库查询</p>
<h2></h2>
<pre style="color:#f8f8f2;background-color:#282a36;"><code><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#6272a4">--第一种
</span></span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#6272a4">--开启
</span></span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#6272a4"></span><span style="color:#ff79c6;font-style:normal;">exec</span> sp_configure <span style="color:#f1fa8c">&#39;show advanced options&#39;</span>,<span style="color:#bd93f9">1</span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>reconfigure
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#ff79c6;font-style:normal;">exec</span> sp_configure <span style="color:#f1fa8c">&#39;Ad Hoc Distributed Queries&#39;</span>,<span style="color:#bd93f9">1</span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>reconfigure
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#6272a4">--执行
</span></span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#6272a4"></span><span style="color:#ff79c6;font-style:normal;">select</span> top <span style="color:#bd93f9">100</span> <span style="color:#ff79c6">*</span> <span style="color:#ff79c6;font-style:normal;">from</span> OPENDATASOURCE(<span style="color:#f1fa8c">&#39;SQLOLEDB&#39;</span>,<span style="color:#f1fa8c">&#39;Data Source=.;User ID=sa;Password=sa&#39;</span>).DataBaseName.dbo.TableName
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#6272a4">--关闭
</span></span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#6272a4"></span><span style="color:#ff79c6;font-style:normal;">exec</span> sp_configure <span style="color:#f1fa8c">&#39;Ad Hoc Distributed Queries&#39;</span>,<span style="color:#bd93f9">0</span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>reconfigure
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#ff79c6;font-style:normal;">exec</span> sp_configure <span style="color:#f1fa8c">&#39;show advanced options&#39;</span>,<span style="color:#bd93f9">0</span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>reconfigure 
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#6272a4">--第二种
</span></span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#6272a4">-- 创建链接服务器
</span></span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#6272a4"></span><span style="color:#ff79c6;font-style:normal;">exec</span> sp_addlinkedserver <span style="color:#f1fa8c">&#39;svr_link&#39;</span>,<span style="color:#f1fa8c">&#39;&#39;</span>,<span style="color:#f1fa8c">&#39;sqloledb&#39;</span>,<span style="color:#f1fa8c">&#39;192.168.1.1&#39;</span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#6272a4">-- 创建登录信息
</span></span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#6272a4"></span><span style="color:#ff79c6;font-style:normal;">exec</span> sp_addlinkedsrvlogin <span style="color:#f1fa8c">&#39;svr_link&#39;</span>,<span style="color:#f1fa8c">&#39;false&#39;</span>,<span style="color:#ff79c6;font-style:normal;">null</span>,<span style="color:#f1fa8c">&#39;sa&#39;</span>,<span style="color:#f1fa8c">&#39;sa&#39;</span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#6272a4">--查询 格式为：链接服务器.数据库名.架构名.表名
</span></span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#6272a4"></span><span style="color:#ff79c6;font-style:normal;">select</span> top <span style="color:#bd93f9">100</span> <span style="color:#ff79c6">*</span> <span style="color:#ff79c6;font-style:normal;">from</span> svr_link.DatabaseName.dbo.TableName
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#6272a4">-- 删除链接服务器
</span></span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#6272a4"></span><span style="color:#ff79c6;font-style:normal;">exec</span> sp_dropserver <span style="color:#f1fa8c">&#39;svr_link&#39;</span>,<span style="color:#f1fa8c">&#39;droplogins&#39;</span>
</span></span></code></pre><p>10.获取数据库死锁(放在master数据库中)</p>
<h2></h2>
<pre style="color:#f8f8f2;background-color:#282a36;"><code><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>USE [master]
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#ff79c6;font-style:normal;">GO</span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#6272a4">/****** Object:  StoredProcedure [dbo].[sp_who_lock]    Script Date: 2017/1/11 15:50:41 ******/</span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#ff79c6;font-style:normal;">SET</span> ANSI_NULLS <span style="color:#ff79c6;font-style:normal;">ON</span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#ff79c6;font-style:normal;">GO</span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#ff79c6;font-style:normal;">SET</span> QUOTED_IDENTIFIER <span style="color:#ff79c6;font-style:normal;">ON</span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#ff79c6;font-style:normal;">GO</span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#ff79c6;font-style:normal;">CREATE</span> <span style="color:#ff79c6;font-style:normal;">procedure</span> [dbo].[sp_who_lock]
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#ff79c6;font-style:normal;">as</span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#ff79c6;font-style:normal;">begin</span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#ff79c6;font-style:normal;">declare</span> <span style="color:#ff79c6">@</span>spid <span style="color:#8be9fd;font-style:italic">int</span>,<span style="color:#ff79c6">@</span>bl <span style="color:#8be9fd;font-style:italic">int</span>,
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span> <span style="color:#ff79c6">@</span>intTransactionCountOnEntry  <span style="color:#8be9fd;font-style:italic">int</span>,
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>        <span style="color:#ff79c6">@</span>intRowcount    <span style="color:#8be9fd;font-style:italic">int</span>,
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>        <span style="color:#ff79c6">@</span>intCountProperties   <span style="color:#8be9fd;font-style:italic">int</span>,
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>        <span style="color:#ff79c6">@</span>intCounter    <span style="color:#8be9fd;font-style:italic">int</span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span> <span style="color:#ff79c6;font-style:normal;">create</span> <span style="color:#ff79c6;font-style:normal;">table</span> <span style="color:#ff79c6">#</span>tmp_lock_who (
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span> id <span style="color:#8be9fd;font-style:italic">int</span> <span style="color:#ff79c6;font-style:normal;">identity</span>(<span style="color:#bd93f9">1</span>,<span style="color:#bd93f9">1</span>),
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span> spid <span style="color:#8be9fd;font-style:italic">smallint</span>,
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span> bl <span style="color:#8be9fd;font-style:italic">smallint</span>)
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span> 
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span> <span style="color:#ff79c6;font-style:normal;">IF</span> <span style="color:#ff79c6">@@</span>ERROR<span style="color:#ff79c6">&lt;&gt;</span><span style="color:#bd93f9">0</span> <span style="color:#ff79c6;font-style:normal;">RETURN</span> <span style="color:#ff79c6">@@</span>ERROR
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span> 
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span> <span style="color:#ff79c6;font-style:normal;">insert</span> <span style="color:#ff79c6;font-style:normal;">into</span> <span style="color:#ff79c6">#</span>tmp_lock_who(spid,bl) <span style="color:#ff79c6;font-style:normal;">select</span>  <span style="color:#bd93f9">0</span> ,blocked
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>   <span style="color:#ff79c6;font-style:normal;">from</span> (<span style="color:#ff79c6;font-style:normal;">select</span> <span style="color:#ff79c6">*</span> <span style="color:#ff79c6;font-style:normal;">from</span> sysprocesses <span style="color:#ff79c6;font-style:normal;">where</span>  blocked<span style="color:#ff79c6">&gt;</span><span style="color:#bd93f9">0</span> ) a 
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>   <span style="color:#ff79c6;font-style:normal;">where</span> <span style="color:#ff79c6;font-style:normal;">not</span> <span style="color:#ff79c6;font-style:normal;">exists</span>(<span style="color:#ff79c6;font-style:normal;">select</span> <span style="color:#ff79c6">*</span> <span style="color:#ff79c6;font-style:normal;">from</span> (<span style="color:#ff79c6;font-style:normal;">select</span> <span style="color:#ff79c6">*</span> <span style="color:#ff79c6;font-style:normal;">from</span> sysprocesses <span style="color:#ff79c6;font-style:normal;">where</span>  blocked<span style="color:#ff79c6">&gt;</span><span style="color:#bd93f9">0</span> ) b 
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>   <span style="color:#ff79c6;font-style:normal;">where</span> a.blocked<span style="color:#ff79c6">=</span>spid)
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>   <span style="color:#ff79c6;font-style:normal;">union</span> <span style="color:#ff79c6;font-style:normal;">select</span> spid,blocked <span style="color:#ff79c6;font-style:normal;">from</span> sysprocesses <span style="color:#ff79c6;font-style:normal;">where</span>  blocked<span style="color:#ff79c6">&gt;</span><span style="color:#bd93f9">0</span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span> <span style="color:#ff79c6;font-style:normal;">IF</span> <span style="color:#ff79c6">@@</span>ERROR<span style="color:#ff79c6">&lt;&gt;</span><span style="color:#bd93f9">0</span> <span style="color:#ff79c6;font-style:normal;">RETURN</span> <span style="color:#ff79c6">@@</span>ERROR 
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>  
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#6272a4">-- 找到临时表的记录数
</span></span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#6272a4"></span> <span style="color:#ff79c6;font-style:normal;">select</span>  <span style="color:#ff79c6">@</span>intCountProperties <span style="color:#ff79c6">=</span> <span style="color:#ff79c6;font-style:normal;">Count</span>(<span style="color:#ff79c6">*</span>),<span style="color:#ff79c6">@</span>intCounter <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span> <span style="color:#ff79c6;font-style:normal;">from</span> <span style="color:#ff79c6">#</span>tmp_lock_who
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span> 
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span> <span style="color:#ff79c6;font-style:normal;">IF</span> <span style="color:#ff79c6">@@</span>ERROR<span style="color:#ff79c6">&lt;&gt;</span><span style="color:#bd93f9">0</span> <span style="color:#ff79c6;font-style:normal;">RETURN</span> <span style="color:#ff79c6">@@</span>ERROR 
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span> 
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span> <span style="color:#ff79c6;font-style:normal;">if</span> <span style="color:#ff79c6">@</span>intCountProperties<span style="color:#ff79c6">=</span><span style="color:#bd93f9">0</span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>  <span style="color:#ff79c6;font-style:normal;">select</span> <span style="color:#f1fa8c">&#39;现在没有阻塞和死锁信息&#39;</span> <span style="color:#ff79c6;font-style:normal;">as</span> message
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#6272a4">-- 循环开始
</span></span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#6272a4"></span>while <span style="color:#ff79c6">@</span>intCounter <span style="color:#ff79c6">&lt;=</span> <span style="color:#ff79c6">@</span>intCountProperties
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#ff79c6;font-style:normal;">begin</span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#6272a4">-- 取第一条记录
</span></span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#6272a4"></span>  <span style="color:#ff79c6;font-style:normal;">select</span>  <span style="color:#ff79c6">@</span>spid <span style="color:#ff79c6">=</span> spid,<span style="color:#ff79c6">@</span>bl <span style="color:#ff79c6">=</span> bl
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>  <span style="color:#ff79c6;font-style:normal;">from</span> <span style="color:#ff79c6">#</span>tmp_lock_who <span style="color:#ff79c6;font-style:normal;">where</span> Id <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">@</span>intCounter 
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span> <span style="color:#ff79c6;font-style:normal;">begin</span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>  <span style="color:#ff79c6;font-style:normal;">if</span> <span style="color:#ff79c6">@</span>spid <span style="color:#ff79c6">=</span><span style="color:#bd93f9">0</span> 
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>            <span style="color:#ff79c6;font-style:normal;">select</span> <span style="color:#f1fa8c">&#39;引起数据库死锁的是: &#39;</span><span style="color:#ff79c6">+</span> <span style="color:#ff79c6;font-style:normal;">CAST</span>(<span style="color:#ff79c6">@</span>bl <span style="color:#ff79c6;font-style:normal;">AS</span> <span style="color:#8be9fd;font-style:italic">VARCHAR</span>(<span style="color:#bd93f9">10</span>)) <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#39;进程号,其执行的SQL语法如下&#39;</span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span> <span style="color:#ff79c6;font-style:normal;">else</span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>            <span style="color:#ff79c6;font-style:normal;">select</span> <span style="color:#f1fa8c">&#39;进程号SPID：&#39;</span><span style="color:#ff79c6">+</span> <span style="color:#ff79c6;font-style:normal;">CAST</span>(<span style="color:#ff79c6">@</span>spid <span style="color:#ff79c6;font-style:normal;">AS</span> <span style="color:#8be9fd;font-style:italic">VARCHAR</span>(<span style="color:#bd93f9">10</span>))<span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#39;被&#39;</span> <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#39;进程号SPID：&#39;</span><span style="color:#ff79c6">+</span> <span style="color:#ff79c6;font-style:normal;">CAST</span>(<span style="color:#ff79c6">@</span>bl <span style="color:#ff79c6;font-style:normal;">AS</span> <span style="color:#8be9fd;font-style:italic">VARCHAR</span>(<span style="color:#bd93f9">10</span>)) <span style="color:#ff79c6">+</span><span style="color:#f1fa8c">&#39;阻塞,其当前进程执行的SQL语法如下&#39;</span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span> DBCC INPUTBUFFER (<span style="color:#ff79c6">@</span>bl )
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span> <span style="color:#ff79c6;font-style:normal;">end</span> 
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#6272a4">-- 循环指针下移
</span></span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#6272a4"></span> <span style="color:#ff79c6;font-style:normal;">set</span> <span style="color:#ff79c6">@</span>intCounter <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">@</span>intCounter <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">1</span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#ff79c6;font-style:normal;">end</span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#ff79c6;font-style:normal;">drop</span> <span style="color:#ff79c6;font-style:normal;">table</span> <span style="color:#ff79c6">#</span>tmp_lock_who
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#ff79c6;font-style:normal;">return</span> <span style="color:#bd93f9">0</span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#ff79c6;font-style:normal;">end</span>
</span></span></code></pre><pre><code>用法：exec sp_who_lock
</code></pre>
<p>11.杀掉死锁进程（放在master数据库中）</p>
<h2></h2>
<pre style="color:#f8f8f2;background-color:#282a36;"><code><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>USE [master]
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#ff79c6;font-style:normal;">GO</span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#6272a4">/****** Object:  StoredProcedure [dbo].[p_killspid]    Script Date: 2017/1/11 15:59:36 ******/</span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#ff79c6;font-style:normal;">SET</span> ANSI_NULLS <span style="color:#ff79c6;font-style:normal;">ON</span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#ff79c6;font-style:normal;">GO</span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#ff79c6;font-style:normal;">SET</span> QUOTED_IDENTIFIER <span style="color:#ff79c6;font-style:normal;">ON</span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#ff79c6;font-style:normal;">GO</span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#ff79c6;font-style:normal;">ALTER</span> proc [dbo].[p_killspid]
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#ff79c6">@</span>dbname <span style="color:#8be9fd;font-style:italic">varchar</span>(<span style="color:#bd93f9">200</span>)    <span style="color:#6272a4">--要关闭进程的数据库名
</span></span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#6272a4"></span><span style="color:#ff79c6;font-style:normal;">as</span>  
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>	<span style="color:#ff79c6;font-style:normal;">begin</span> 
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>    <span style="color:#ff79c6;font-style:normal;">declare</span> <span style="color:#ff79c6">@</span><span style="color:#ff79c6;font-style:normal;">sql</span>  nvarchar(<span style="color:#bd93f9">500</span>)  
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>    <span style="color:#ff79c6;font-style:normal;">declare</span> <span style="color:#ff79c6">@</span>spid nvarchar(<span style="color:#bd93f9">20</span>)
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>    <span style="color:#ff79c6;font-style:normal;">declare</span> <span style="color:#ff79c6">#</span>tb <span style="color:#ff79c6;font-style:normal;">cursor</span> <span style="color:#ff79c6;font-style:normal;">for</span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>        <span style="color:#ff79c6;font-style:normal;">select</span> spid<span style="color:#ff79c6">=</span><span style="color:#ff79c6;font-style:normal;">cast</span>(spid <span style="color:#ff79c6;font-style:normal;">as</span> <span style="color:#8be9fd;font-style:italic">varchar</span>(<span style="color:#bd93f9">20</span>)) <span style="color:#ff79c6;font-style:normal;">from</span> master..sysprocesses <span style="color:#ff79c6;font-style:normal;">where</span> dbid<span style="color:#ff79c6">=</span>db_id(<span style="color:#ff79c6">@</span>dbname)
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>    <span style="color:#ff79c6;font-style:normal;">open</span> <span style="color:#ff79c6">#</span>tb
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>    <span style="color:#ff79c6;font-style:normal;">fetch</span> <span style="color:#ff79c6;font-style:normal;">next</span> <span style="color:#ff79c6;font-style:normal;">from</span> <span style="color:#ff79c6">#</span>tb <span style="color:#ff79c6;font-style:normal;">into</span> <span style="color:#ff79c6">@</span>spid
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>    while <span style="color:#ff79c6">@@</span>fetch_status<span style="color:#ff79c6">=</span><span style="color:#bd93f9">0</span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>    <span style="color:#ff79c6;font-style:normal;">begin</span>  
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>        <span style="color:#ff79c6;font-style:normal;">exec</span>(<span style="color:#f1fa8c">&#39;kill &#39;</span><span style="color:#ff79c6">+@</span>spid)
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>        <span style="color:#ff79c6;font-style:normal;">fetch</span> <span style="color:#ff79c6;font-style:normal;">next</span> <span style="color:#ff79c6;font-style:normal;">from</span> <span style="color:#ff79c6">#</span>tb <span style="color:#ff79c6;font-style:normal;">into</span> <span style="color:#ff79c6">@</span>spid
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>    <span style="color:#ff79c6;font-style:normal;">end</span>  
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>    <span style="color:#ff79c6;font-style:normal;">close</span> <span style="color:#ff79c6">#</span>tb
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>    <span style="color:#ff79c6;font-style:normal;">deallocate</span> <span style="color:#ff79c6">#</span>tb
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>	<span style="color:#ff79c6;font-style:normal;">end</span>
</span></span></code></pre><pre><code>用法：exec p_killspid  '数据库名'
</code></pre>
<p>12.查询死锁表信息（放在master数据库中）</p>
<h2></h2>
<pre style="color:#f8f8f2;background-color:#282a36;"><code><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>USE [master]
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#ff79c6;font-style:normal;">GO</span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#6272a4">/****** Object:  StoredProcedure [dbo].[sp_lock_table]    Script Date: 2017/1/11 16:02:01 ******/</span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#ff79c6;font-style:normal;">SET</span> ANSI_NULLS <span style="color:#ff79c6;font-style:normal;">ON</span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#ff79c6;font-style:normal;">GO</span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#ff79c6;font-style:normal;">SET</span> QUOTED_IDENTIFIER <span style="color:#ff79c6;font-style:normal;">ON</span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#ff79c6;font-style:normal;">GO</span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#ff79c6;font-style:normal;">ALTER</span> <span style="color:#ff79c6;font-style:normal;">PROCEDURE</span> [dbo].[sp_lock_table]
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#ff79c6;font-style:normal;">AS</span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#ff79c6;font-style:normal;">BEGIN</span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>	
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#6272a4">--查看锁信息
</span></span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#6272a4"></span><span style="color:#ff79c6;font-style:normal;">create</span> <span style="color:#ff79c6;font-style:normal;">table</span> <span style="color:#ff79c6">#</span>t(req_spid <span style="color:#8be9fd;font-style:italic">int</span>,obj_name sysname)
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#ff79c6;font-style:normal;">declare</span> <span style="color:#ff79c6">@</span>s nvarchar(<span style="color:#bd93f9">4000</span>)
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>    ,<span style="color:#ff79c6">@</span>rid <span style="color:#8be9fd;font-style:italic">int</span>,<span style="color:#ff79c6">@</span>dbname sysname,<span style="color:#ff79c6">@</span>id <span style="color:#8be9fd;font-style:italic">int</span>,<span style="color:#ff79c6">@</span>objname sysname
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#ff79c6;font-style:normal;">declare</span> tb <span style="color:#ff79c6;font-style:normal;">cursor</span> <span style="color:#ff79c6;font-style:normal;">for</span> 
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>    <span style="color:#ff79c6;font-style:normal;">select</span> <span style="color:#ff79c6;font-style:normal;">distinct</span> req_spid,dbname<span style="color:#ff79c6">=</span>db_name(rsc_dbid),rsc_objid
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>    <span style="color:#ff79c6;font-style:normal;">from</span> master..syslockinfo <span style="color:#ff79c6;font-style:normal;">where</span> rsc_type <span style="color:#ff79c6;font-style:normal;">in</span>(<span style="color:#bd93f9">4</span>,<span style="color:#bd93f9">5</span>)
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#ff79c6;font-style:normal;">open</span> tb
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#ff79c6;font-style:normal;">fetch</span> <span style="color:#ff79c6;font-style:normal;">next</span> <span style="color:#ff79c6;font-style:normal;">from</span> tb <span style="color:#ff79c6;font-style:normal;">into</span> <span style="color:#ff79c6">@</span>rid,<span style="color:#ff79c6">@</span>dbname,<span style="color:#ff79c6">@</span>id
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>while <span style="color:#ff79c6">@@</span>fetch_status<span style="color:#ff79c6">=</span><span style="color:#bd93f9">0</span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#ff79c6;font-style:normal;">begin</span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>    <span style="color:#ff79c6;font-style:normal;">set</span> <span style="color:#ff79c6">@</span>s<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;select @objname=name from [&#39;</span><span style="color:#ff79c6">+@</span>dbname<span style="color:#ff79c6">+</span><span style="color:#f1fa8c">&#39;]..sysobjects where id=@id&#39;</span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>    <span style="color:#ff79c6;font-style:normal;">exec</span> sp_executesql <span style="color:#ff79c6">@</span>s,N<span style="color:#f1fa8c">&#39;@objname sysname out,@id int&#39;</span>,<span style="color:#ff79c6">@</span>objname <span style="color:#ff79c6;font-style:normal;">out</span>,<span style="color:#ff79c6">@</span>id
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>    <span style="color:#ff79c6;font-style:normal;">insert</span> <span style="color:#ff79c6;font-style:normal;">into</span> <span style="color:#ff79c6">#</span>t <span style="color:#ff79c6;font-style:normal;">values</span>(<span style="color:#ff79c6">@</span>rid,<span style="color:#ff79c6">@</span>objname)
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>    <span style="color:#ff79c6;font-style:normal;">fetch</span> <span style="color:#ff79c6;font-style:normal;">next</span> <span style="color:#ff79c6;font-style:normal;">from</span> tb <span style="color:#ff79c6;font-style:normal;">into</span> <span style="color:#ff79c6">@</span>rid,<span style="color:#ff79c6">@</span>dbname,<span style="color:#ff79c6">@</span>id
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#ff79c6;font-style:normal;">end</span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#ff79c6;font-style:normal;">close</span> tb
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#ff79c6;font-style:normal;">deallocate</span> tb
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#ff79c6;font-style:normal;">select</span> 进程id<span style="color:#ff79c6">=</span>a.req_spid
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>    ,数据库<span style="color:#ff79c6">=</span>db_name(rsc_dbid)
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>    ,类型<span style="color:#ff79c6">=</span><span style="color:#ff79c6;font-style:normal;">case</span> rsc_type <span style="color:#ff79c6;font-style:normal;">when</span> <span style="color:#bd93f9">1</span> <span style="color:#ff79c6;font-style:normal;">then</span> <span style="color:#f1fa8c">&#39;NULL 资源（未使用）&#39;</span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>        <span style="color:#ff79c6;font-style:normal;">when</span> <span style="color:#bd93f9">2</span> <span style="color:#ff79c6;font-style:normal;">then</span> <span style="color:#f1fa8c">&#39;数据库&#39;</span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>        <span style="color:#ff79c6;font-style:normal;">when</span> <span style="color:#bd93f9">3</span> <span style="color:#ff79c6;font-style:normal;">then</span> <span style="color:#f1fa8c">&#39;文件&#39;</span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>        <span style="color:#ff79c6;font-style:normal;">when</span> <span style="color:#bd93f9">4</span> <span style="color:#ff79c6;font-style:normal;">then</span> <span style="color:#f1fa8c">&#39;索引&#39;</span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>        <span style="color:#ff79c6;font-style:normal;">when</span> <span style="color:#bd93f9">5</span> <span style="color:#ff79c6;font-style:normal;">then</span> <span style="color:#f1fa8c">&#39;表&#39;</span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>        <span style="color:#ff79c6;font-style:normal;">when</span> <span style="color:#bd93f9">6</span> <span style="color:#ff79c6;font-style:normal;">then</span> <span style="color:#f1fa8c">&#39;页&#39;</span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>        <span style="color:#ff79c6;font-style:normal;">when</span> <span style="color:#bd93f9">7</span> <span style="color:#ff79c6;font-style:normal;">then</span> <span style="color:#f1fa8c">&#39;键&#39;</span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>        <span style="color:#ff79c6;font-style:normal;">when</span> <span style="color:#bd93f9">8</span> <span style="color:#ff79c6;font-style:normal;">then</span> <span style="color:#f1fa8c">&#39;扩展盘区&#39;</span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>        <span style="color:#ff79c6;font-style:normal;">when</span> <span style="color:#bd93f9">9</span> <span style="color:#ff79c6;font-style:normal;">then</span> <span style="color:#f1fa8c">&#39;RID（行 ID)&#39;</span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>        <span style="color:#ff79c6;font-style:normal;">when</span> <span style="color:#bd93f9">10</span> <span style="color:#ff79c6;font-style:normal;">then</span> <span style="color:#f1fa8c">&#39;应用程序&#39;</span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>    <span style="color:#ff79c6;font-style:normal;">end</span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>    ,对象id<span style="color:#ff79c6">=</span>rsc_objid
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>    ,对象名<span style="color:#ff79c6">=</span>b.obj_name
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>    ,rsc_indid
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span> <span style="color:#ff79c6;font-style:normal;">from</span> master..syslockinfo a <span style="color:#ff79c6;font-style:normal;">left</span> <span style="color:#ff79c6;font-style:normal;">join</span> <span style="color:#ff79c6">#</span>t b <span style="color:#ff79c6;font-style:normal;">on</span> a.req_spid<span style="color:#ff79c6">=</span>b.req_spid
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#ff79c6;font-style:normal;">drop</span> <span style="color:#ff79c6;font-style:normal;">table</span> <span style="color:#ff79c6">#</span>t
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#ff79c6;font-style:normal;">END</span>
</span></span></code></pre><pre><code>用法：exec sp_lock_table
</code></pre>
<p>13.查询执行慢的SQL</p>
<h2></h2>
<pre style="color:#f8f8f2;background-color:#282a36;"><code><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#ff79c6;font-style:normal;">SELECT</span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>(total_elapsed_time <span style="color:#ff79c6">/</span> execution_count)<span style="color:#ff79c6">/</span><span style="color:#bd93f9">1000</span> N<span style="color:#f1fa8c">&#39;平均时间ms&#39;</span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>,total_elapsed_time<span style="color:#ff79c6">/</span><span style="color:#bd93f9">1000</span> N<span style="color:#f1fa8c">&#39;总花费时间ms&#39;</span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>,total_worker_time<span style="color:#ff79c6">/</span><span style="color:#bd93f9">1000</span> N<span style="color:#f1fa8c">&#39;所用的CPU总时间ms&#39;</span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>,total_physical_reads N<span style="color:#f1fa8c">&#39;物理读取总次数&#39;</span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>,total_logical_reads<span style="color:#ff79c6">/</span>execution_count N<span style="color:#f1fa8c">&#39;每次逻辑读次数&#39;</span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>,total_logical_reads N<span style="color:#f1fa8c">&#39;逻辑读取总次数&#39;</span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>,total_logical_writes N<span style="color:#f1fa8c">&#39;逻辑写入总次数&#39;</span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>,execution_count N<span style="color:#f1fa8c">&#39;执行次数&#39;</span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>,<span style="color:#ff79c6;font-style:normal;">SUBSTRING</span>(st.<span style="color:#8be9fd;font-style:italic">text</span>, (qs.statement_start_offset<span style="color:#ff79c6">/</span><span style="color:#bd93f9">2</span>) <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">1</span>,
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>((<span style="color:#ff79c6;font-style:normal;">CASE</span> statement_end_offset
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#ff79c6;font-style:normal;">WHEN</span> <span style="color:#ff79c6">-</span><span style="color:#bd93f9">1</span> <span style="color:#ff79c6;font-style:normal;">THEN</span> DATALENGTH(st.<span style="color:#8be9fd;font-style:italic">text</span>)
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#ff79c6;font-style:normal;">ELSE</span> qs.statement_end_offset <span style="color:#ff79c6;font-style:normal;">END</span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#ff79c6">-</span> qs.statement_start_offset)<span style="color:#ff79c6">/</span><span style="color:#bd93f9">2</span>) <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">1</span>) N<span style="color:#f1fa8c">&#39;执行语句&#39;</span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>,creation_time N<span style="color:#f1fa8c">&#39;语句编译时间&#39;</span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>,last_execution_time N<span style="color:#f1fa8c">&#39;上次执行时间&#39;</span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#ff79c6;font-style:normal;">FROM</span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>sys.dm_exec_query_stats <span style="color:#ff79c6;font-style:normal;">AS</span> qs <span style="color:#ff79c6;font-style:normal;">CROSS</span> APPLY sys.dm_exec_sql_text(qs.sql_handle) st
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#ff79c6;font-style:normal;">WHERE</span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#ff79c6;font-style:normal;">SUBSTRING</span>(st.<span style="color:#8be9fd;font-style:italic">text</span>, (qs.statement_start_offset<span style="color:#ff79c6">/</span><span style="color:#bd93f9">2</span>) <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">1</span>,
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>((<span style="color:#ff79c6;font-style:normal;">CASE</span> statement_end_offset
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#ff79c6;font-style:normal;">WHEN</span> <span style="color:#ff79c6">-</span><span style="color:#bd93f9">1</span> <span style="color:#ff79c6;font-style:normal;">THEN</span> DATALENGTH(st.<span style="color:#8be9fd;font-style:italic">text</span>)
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#ff79c6;font-style:normal;">ELSE</span> qs.statement_end_offset <span style="color:#ff79c6;font-style:normal;">END</span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#ff79c6">-</span> qs.statement_start_offset)<span style="color:#ff79c6">/</span><span style="color:#bd93f9">2</span>) <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">1</span>) <span style="color:#ff79c6;font-style:normal;">not</span> <span style="color:#ff79c6;font-style:normal;">like</span> <span style="color:#f1fa8c">&#39;%fetch%&#39;</span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#ff79c6;font-style:normal;">ORDER</span> <span style="color:#ff79c6;font-style:normal;">BY</span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>total_elapsed_time <span style="color:#ff79c6">/</span> execution_count <span style="color:#ff79c6;font-style:normal;">DESC</span>;
</span></span></code></pre><p>14.查询执行过的SQL计划</p>
<h2></h2>
<pre style="color:#f8f8f2;background-color:#282a36;"><code><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#ff79c6;font-style:normal;">SELECT</span> TOP <span style="color:#bd93f9">1000</span> 
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>    QS.creation_time,
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>    <span style="color:#ff79c6;font-style:normal;">SUBSTRING</span>(ST.<span style="color:#8be9fd;font-style:italic">text</span>,(QS.statement_start_offset<span style="color:#ff79c6">/</span><span style="color:#bd93f9">2</span>)<span style="color:#ff79c6">+</span><span style="color:#bd93f9">1</span>,
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>    ((<span style="color:#ff79c6;font-style:normal;">CASE</span> QS.statement_end_offset <span style="color:#ff79c6;font-style:normal;">WHEN</span> <span style="color:#ff79c6">-</span><span style="color:#bd93f9">1</span> <span style="color:#ff79c6;font-style:normal;">THEN</span> DATALENGTH(st.<span style="color:#8be9fd;font-style:italic">text</span>) 
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>        <span style="color:#ff79c6;font-style:normal;">ELSE</span> QS.statement_end_offset <span style="color:#ff79c6;font-style:normal;">END</span> <span style="color:#ff79c6">-</span> QS.statement_start_offset)<span style="color:#ff79c6">/</span><span style="color:#bd93f9">2</span>) <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">1</span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>    ) <span style="color:#ff79c6;font-style:normal;">AS</span> statement_text,
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>    ST.<span style="color:#8be9fd;font-style:italic">text</span>,
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>    QS.total_worker_time,
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>    QS.last_worker_time,
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>    QS.max_worker_time,
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>    QS.min_worker_time
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#ff79c6;font-style:normal;">FROM</span> 
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>    sys.dm_exec_query_stats QS
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#ff79c6;font-style:normal;">CROSS</span> APPLY 
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span>    sys.dm_exec_sql_text(QS.sql_handle) ST
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#ff79c6;font-style:normal;">WHERE</span> QS.creation_time <span style="color:#ff79c6;font-style:normal;">BETWEEN</span> <span style="color:#f1fa8c">&#39;2018-05-22 15:00:00&#39;</span> <span style="color:#ff79c6;font-style:normal;">AND</span> <span style="color:#f1fa8c">&#39;2018-05-22 15:10:00&#39;</span>
</span></span><span style="display:flex;padding-left:10px;display:block;font-family:'Consolas','DejaVu Sans Mono','Bitstream Vera Sans Mono', monospace"><span><span style="color:#ff79c6;font-style:normal;">ORDER</span> <span style="color:#ff79c6;font-style:normal;">BY</span> QS.creation_time <span style="color:#ff79c6;font-style:normal;">DESC</span>
</span></span></code></pre>
            </div>
        </div>   
    </div>
</body>
</html>